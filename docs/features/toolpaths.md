# Toolpath Generation

Generate G-code for CNC machining operations.

---

## Operation Types

### Pocket (Area Clearing)

Remove material from enclosed regions.

**Parameters:**

| Parameter | Description | Typical Range |
|-----------|-------------|---------------|
| Tool Diameter | Cutting tool size | 3-12 mm |
| Stepover % | Overlap between passes | 40-60% |
| Stepdown | Depth per pass | 1-3 mm |
| Feed Rate | Cutting speed | 1000-3000 mm/min |
| Plunge Rate | Z-axis entry speed | 300-500 mm/min |

**Strategies:**

| Strategy | Description | Best For |
|----------|-------------|----------|
| Offset | Concentric passes from outside in | General purpose |
| Zigzag | Back-and-forth linear passes | Large flat areas |
| Adaptive | Constant engagement angle | Hard materials |

---

### Contour (Profile Cutting)

Follow the outline of geometry to cut parts out.

**Parameters:**

| Parameter | Description | Typical Range |
|-----------|-------------|---------------|
| Tool Diameter | Cutting tool size | 3-12 mm |
| Offset | Inside, Outside, or On-line | - |
| Tabs | Holding tabs to prevent part movement | 2-4 per part |
| Tab Width | Width of each tab | 5-10 mm |
| Tab Height | Height of each tab | 2-3 mm |

**Multi-Pass Options:**

- **Roughing Pass**: Leave stock for finishing (e.g., 0.5mm)
- **Finishing Pass**: Final dimension cut
- **Spring Pass**: Second finishing pass at same depth

---

### Drilling

Point-to-point hole operations.

**Parameters:**

| Parameter | Description |
|-----------|-------------|
| Drill Diameter | Tool size |
| Depth | Hole depth |
| Peck Depth | Depth per peck cycle |
| Dwell | Pause at bottom (seconds) |

**Cycles:**

| Cycle | Description |
|-------|-------------|
| Simple | Drill to depth, retract |
| Peck | Incremental depth with full retract |
| Chip Break | Incremental with partial retract |
| Bore | For larger holes |

---

### V-Carving

Engraving with V-shaped tools.

**Parameters:**

| Parameter | Description |
|-----------|-------------|
| V-Angle | Tool tip angle (60°, 90°, etc.) |
| Flat Depth | Depth for flat-bottom areas |
| Max Depth | Deepest cut allowed |

---

## Toolpath Settings

### Tool Library

Define commonly used tools:

```yaml
tools:
  - id: 1
    name: "6mm Endmill"
    diameter: 6.0
    flutes: 2
    type: endmill

  - id: 2
    name: "3mm Ball Nose"
    diameter: 3.0
    flutes: 2
    type: ballnose

  - id: 3
    name: "90° V-Bit"
    diameter: 6.0
    angle: 90
    type: vbit
```

### Feeds and Speeds

**Basic Formula:**

```
Chip Load = Feed Rate ÷ (RPM × Flutes)
```

**Recommended Chip Loads:**

| Material | Endmill Chip Load |
|----------|-------------------|
| Softwood | 0.2-0.3 mm |
| Hardwood | 0.1-0.2 mm |
| MDF | 0.15-0.25 mm |
| Acrylic | 0.05-0.1 mm |
| Aluminum | 0.05-0.1 mm |

### Safety Heights

| Height | Purpose | Typical Value |
|--------|---------|---------------|
| Clearance | Travel between operations | 5-10 mm above stock |
| Retract | Lift after each cut | 2-5 mm above stock |
| Safe Z | Maximum safe height | Above all fixtures |

---

## Preview

Before exporting, preview the toolpath:

- **2D View**: Top-down path visualization
- **3D View**: Simulated material removal
- **Time Estimate**: Approximate run time
- **Statistics**: Total distance, number of retracts

### Color Coding

| Color | Movement Type |
|-------|---------------|
| Blue | Rapid (G0) |
| Green | Feed (G1) |
| Red | Plunge |
| Yellow | Retract |

---

## Export

### G-code Output

Export to your controller's format:

```gcode
; Generated by Luthier's ToolBox
; Tool: 6mm Endmill
; Operation: Pocket
G21 ; mm mode
G90 ; absolute positioning
G17 ; XY plane
M3 S18000 ; spindle on
G0 Z10.0 ; safe height
G0 X0.0 Y0.0
...
M5 ; spindle off
M30 ; program end
```

### Post Processor Selection

| Controller | Post Processor |
|------------|----------------|
| Grbl | `grbl` |
| Mach3/4 | `mach` |
| LinuxCNC | `linuxcnc` |
| Carbide Motion | `carbide` |
| Generic | `generic` |

---

## API Usage

```python
import requests

# Generate pocket toolpath
response = requests.post(
    "http://localhost:8000/api/cam/pocket",
    json={
        "geometry_id": "abc123",
        "tool": {
            "diameter": 6.0,
            "flutes": 2
        },
        "params": {
            "stepover_pct": 45,
            "stepdown": 2.0,
            "feed_rate": 2000,
            "plunge_rate": 500,
            "rpm": 18000,
            "depth": 10.0
        }
    }
)

# Get G-code
gcode = response.json()["gcode"]
```

---

## Best Practices

### For Clean Cuts

1. Use climb milling when possible (tool rotation matches feed direction)
2. Keep stepover under 50% for finishing
3. Take multiple shallow passes rather than one deep pass
4. Let the tool cool between heavy cuts

### For Efficiency

1. Optimize tool changes (group operations by tool)
2. Use appropriate rapid heights (not too high)
3. Order operations to minimize travel
4. Use adaptive clearing for large pockets

### For Safety

1. Always verify spindle direction before cutting
2. Secure workpiece with appropriate clamping
3. Start with conservative feeds/speeds
4. Use dust collection

---

## Troubleshooting

### Poor Surface Finish

- Reduce feed rate
- Increase RPM (within tool limits)
- Check for tool runout
- Use finishing pass

### Chatter or Vibration

- Reduce stepdown
- Reduce stepover
- Check tool stickout (minimize)
- Check workpiece rigidity

### Tool Breakage

- Reduce feed rate
- Reduce stepdown
- Check for chip evacuation
- Verify material hardness

---

## Related

- [DXF Import](dxf-import.md) - Import geometry
- [Machine Profiles](../cam/machine-profiles.md) - Configure your CNC
- [Post Processors](../cam/post-processors.md) - G-code customization
- [Safety & RMOS](../cam/safety-rmos.md) - Manufacturing safety
