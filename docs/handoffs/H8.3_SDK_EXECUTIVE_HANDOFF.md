# H8.3 SDK Typed Helpers - Executive Handoff

**Date**: 2025-12-27  
**Version**: 1.0 - Foundation Complete  
**Status**: Phase 1 ✅ Complete | Phase 2 Pending  
**Classification**: Executive Technical Handoff  

---

## Executive Summary

### What Works (Phase 1 Complete)

• **Transport Layer**: `apiFetchRaw` returns `{data, response}` for header access (115 lines)  
• **3 Endpoint Helpers**: roughingGcode(), roughingGcodeIntent(), runPipeline()  
• **Type Safety**: All payloads/responses have TypeScript interfaces  
• **Header Parsing**: X-CAM-Summary extraction with graceful error handling  
• **Request-ID Propagation**: All helpers return `{...result, requestId}`  
• **Test Coverage**: 6/6 tests passing (100%)  
• **Documentation**: 4 guides (architecture, usage, tracking, quickref)  

### What's Missing

• **Component Migration**: Zero components use new helpers (all still use raw fetch())  
• **CI Gate**: Legacy usage detection not integrated into CI workflow  
• **Coverage**: Only 3 of 20+ CAM endpoints have helpers  
• **Schema Tightening**: Types use `unknown[]` placeholders  

### Critical Risks

**CRITICAL**: Zero component migration - infrastructure built but unused  
**CRITICAL**: No CI enforcement - new code can bypass typed helpers  
**HIGH**: Schema drift - `unknown[]` types need tightening as backend stabilizes  

### Do Not Change Without Review

• `apiFetchRaw` return shape `{data, response}` - breaks all helpers  
• `postFormRaw` Content-Type handling - MUST NOT set (browser sets boundary)  
• Helper return shape `{...result, requestId}` - components depend on this  

---

## System Architecture

### File Structure

```
packages/client/src/sdk/
├── core/
│   └── apiFetchRaw.ts          → {data, response} transport
├── endpoints/
│   ├── index.ts                → Top-level exports (cam, etc.)
│   ├── README.md               → Architecture guide
│   └── cam/
│       ├── cam.ts              → CAM namespace
│       ├── types.ts            → TypeScript types
│       ├── roughing.ts         → roughingGcode + roughingGcodeIntent
│       ├── pipeline.ts         → runPipeline
│       ├── USAGE.md            → Usage examples
│       └── __tests__/
│           └── cam.endpoints.test.ts  → Test suite
└── index.ts                    → Main export (updated)
```

### Key Design Decisions

**Why apiFetchRaw?**  
Original `apiFetch` returns data only. Need Response object for custom header parsing (X-CAM-Summary). Created new variant without breaking existing code.

**Why FormData special handling?**  
If Content-Type header is set on FormData, browser can't add multipart boundary. `postFormRaw` explicitly deletes Content-Type before fetch().

**Why all helpers return requestId?**  
Governance requirement for audit/tracing. Every API call must be correlatable via request-id.

**Why loose types (`unknown[]`)?**  
Backend schemas still evolving. Loose types allow gradual tightening without breaking changes.

---

## API Surface

### Backend Routers Called

**POST /api/cam/roughing_gcode** (Legacy Entity-Based)  
- **Helper**: `cam.roughingGcode(payload)`  
- **Input**: `RoughingGcodeRequest` (entities, tool_diameter, etc.)  
- **Output**: Plain text G-code + `X-CAM-Summary` header  
- **Returns**: `{gcode: string, summary: CamSummary | null, requestId: string}`  

**POST /api/cam/roughing_gcode_intent** (Intent-Native)  
- **Helper**: `cam.roughingGcodeIntent(intent, strict?)`  
- **Input**: `CamIntentV1` envelope + optional `?strict=true` query param  
- **Output**: Plain text G-code + `X-CAM-Summary` header  
- **Strict Mode**: Returns 422 on normalization issues if strict=true  
- **Returns**: `{gcode: string, summary: CamSummary | null, requestId: string}`  

**POST /api/cam/pipeline/run** (FormData)  
- **Helper**: `cam.runPipeline(formData)`  
- **Input**: multipart/form-data (config JSON + file uploads)  
- **Output**: JSON result object  
- **Returns**: `{result: unknown, requestId: string}`  

---

## Core Functions

### Transport Layer

**`apiFetchRaw<T>(url, options?)`**  
- **Location**: `packages/client/src/sdk/core/apiFetchRaw.ts:15-40`  
- **Returns**: `{data: T, response: Response}`  
- **Throws**: `ApiError` on HTTP failure  
- **Side Effects**: Logs deprecation warnings if X-Deprecated header present  

**`postRaw<T>(url, body)`**  
- **Location**: `packages/client/src/sdk/core/apiFetchRaw.ts:45-58`  
- **Sets**: Content-Type: application/json  
- **Returns**: `{data: T, response: Response}`  

**`postFormRaw<T>(url, form)`**  
- **Location**: `packages/client/src/sdk/core/apiFetchRaw.ts:63-80`  
- **CRITICAL**: Does NOT set Content-Type (browser sets multipart boundary)  
- **Returns**: `{data: T, response: Response}`  

### Header Parsing

**`parseCamSummary(response)`**  
- **Location**: `packages/client/src/sdk/endpoints/cam/roughing.ts:12-28`  
- **Returns**: `CamSummary | null`  
- **Error Handling**: Logs warning on malformed JSON, returns null (never throws)  

**`extractRequestId(response)`**  
- **Location**: `packages/client/src/sdk/core/headers.ts:45-50`  
- **Returns**: `string` (empty string if header missing)  

### Endpoint Helpers

**`roughingGcode(payload)`**  
- **Location**: `packages/client/src/sdk/endpoints/cam/roughing.ts:35-50`  
- **Calls**: `POST /api/cam/roughing_gcode`  
- **Returns**: `{gcode, summary, requestId}`  

**`roughingGcodeIntent(intent, strict?)`**  
- **Location**: `packages/client/src/sdk/endpoints/cam/roughing.ts:55-75`  
- **Calls**: `POST /api/cam/roughing_gcode_intent?strict={bool}`  
- **Strict Mode**: Throws ApiError 422 on validation failure  
- **Returns**: `{gcode, summary, requestId}`  

**`runPipeline(form)`**  
- **Location**: `packages/client/src/sdk/endpoints/cam/pipeline.ts:12-25`  
- **Calls**: `POST /api/cam/pipeline/run`  
- **Uses**: `postFormRaw` (no Content-Type override)  
- **Returns**: `{result, requestId}`  

---

## Execution Flows

### Flow: Roughing G-code Generation

1. Component calls `cam.roughingGcode(payload)`  
2. Helper calls `postRaw<string>("/api/cam/roughing_gcode", payload)`  
3. Transport adds X-Request-Id header, POSTs to backend  
4. Backend validates, generates G-code, returns with X-CAM-Summary header  
5. Transport checks response.ok, throws ApiError if false  
6. Helper calls `parseCamSummary()` to extract header  
7. Helper calls `extractRequestId()` to get request-id  
8. Helper returns `{gcode, summary, requestId}` to component  

### Flow: Pipeline with FormData

1. Component constructs FormData with config + files  
2. Component calls `cam.runPipeline(formData)`  
3. Helper calls `postFormRaw<unknown>("/api/cam/pipeline/run", formData)`  
4. Transport adds X-Request-Id header, **deletes Content-Type**, POSTs to backend  
5. Browser adds Content-Type with multipart boundary  
6. Backend parses multipart, executes pipeline, returns JSON result  
7. Helper extracts request-id, returns `{result, requestId}`  

### Flow: Strict Mode Validation

1. Component calls `cam.roughingGcodeIntent(intent, true)`  
2. Helper appends `?strict=true` to URL  
3. Backend normalizes intent, finds issues  
4. Backend returns 422 with issues in response body  
5. Transport throws ApiError with status 422, details include issues  
6. Component catch block checks `err.is(422)`, displays validation errors  

---

## Risks & Gaps

### Critical Risks

**RISK-001: Zero Component Migration**  
- **Severity**: CRITICAL  
- **Impact**: No value delivered - infrastructure unused  
- **Mitigation**: Prioritize Phase 2 immediately  

**RISK-002: No CI Gate**  
- **Severity**: CRITICAL  
- **Impact**: New code can bypass helpers  
- **Mitigation**: Add legacy_usage_gate.py to CI workflow  

### High Risks

**RISK-003: Schema Drift**  
- **Severity**: HIGH  
- **Impact**: `unknown[]` types may cause runtime errors  
- **Mitigation**: Track backend changes, tighten incrementally  

### Confirmed Gaps

- Adaptive pocketing helpers missing  
- Helical ramping helpers missing  
- Drilling pattern helpers missing  
- Compare endpoint helpers missing  
- RMOS endpoint helpers missing  
- Zod runtime validation not implemented  
- CI gate not integrated  

---

## Verification Gates

### Compilation

```bash
cd packages/client
npm run type-check  # Must pass (0 errors)
npm run build       # Must complete
```

### Tests

```bash
cd packages/client
npm run test -- src/sdk/endpoints/cam/__tests__/cam.endpoints.test.ts
# Expected: 6/6 passing
```

### Invariants

1. All helpers MUST return `{...result, requestId}`  
2. All helpers MUST use apiFetchRaw (no direct fetch())  
3. postFormRaw MUST NOT set Content-Type  
4. parseCamSummary MUST NOT throw on malformed JSON  

---

## Handoff Checklist

### First Hour

- [ ] Clone/pull repo  
- [ ] Run `npm install` in packages/client  
- [ ] Run test suite - verify 6/6 passing  
- [ ] Read this handoff  
- [ ] Read `packages/client/src/sdk/endpoints/README.md`  
- [ ] Read `packages/client/src/sdk/endpoints/cam/USAGE.md`  

### Phase 2: Component Migration (Next Sprint)

- [ ] Identify CamPipelineRunner.vue component  
- [ ] Replace fetch() with cam.runPipeline()  
- [ ] Update error handling to use ApiError  
- [ ] Add request-id to UI debug panel  
- [ ] Update tests to mock helper not fetch  
- [ ] Repeat for CAMEssentialsLab.vue  
- [ ] Repeat for RoughingIntentLab.vue  

### DO NOT TOUCH

- **DO NOT** change apiFetchRaw return shape  
- **DO NOT** set Content-Type in postFormRaw  
- **DO NOT** remove requestId from helper returns  
- **DO NOT** bypass assertRequestId checks  
- **DO NOT** use `any` types in helper signatures  

### Smoke Tests

```bash
# Test 1: Imports work
cd packages/client
node -e "import('./src/sdk/endpoints/cam/roughing.js').then(() => console.log('OK'))"

# Test 2: Unit tests pass
npm run test -- src/sdk/endpoints/cam/__tests__/cam.endpoints.test.ts

# Test 3: Build succeeds
npm run build

# Test 4: Backend healthy (requires API running)
curl http://localhost:8000/health
```

### Known Sharp Edges

1. **FormData Content-Type**: Setting header breaks multipart uploads  
2. **parseCamSummary null**: Returns null if header missing (not error)  
3. **Strict mode**: May reject valid intents with minor normalizations  
4. **Empty request-id**: Returns "" not null if header missing  
5. **ApiError details**: Typed as `unknown`, check structure before access  
6. **Pipeline result**: Typed as `unknown`, cast after validation  
7. **Test mocking**: Mock helpers not fetch() or tests fail  

---

## Code Index

### Transport Layer
- `apiFetchRaw.ts` → Low-level HTTP with {data, response}  
- `apiFetch.ts` → Simple HTTP (existing, unchanged)  
- `errors.ts` → ApiError with request-id  
- `headers.ts` → Request-id + deprecation utilities  

### Endpoint Helpers
- `endpoints/index.ts` → Top-level (cam, etc.)  
- `endpoints/cam/cam.ts` → CAM aggregator  
- `endpoints/cam/types.ts` → TypeScript types  
- `endpoints/cam/roughing.ts` → Roughing helpers  
- `endpoints/cam/pipeline.ts` → Pipeline helper  

### Tests
- `endpoints/cam/__tests__/cam.endpoints.test.ts` → 6 unit tests  

### Documentation
- `endpoints/README.md` → Architecture overview  
- `endpoints/cam/USAGE.md` → Usage examples  
- `docs/H8.3_SDK_MIGRATION_TRACKING.md` → Migration checklist  
- `docs/quickref/H8.3_SDK_QUICKREF.md` → Quick reference  

---

## Next Actions

**Immediate** (Next 2 weeks):
1. Migrate CamPipelineRunner.vue  
2. Migrate CAMEssentialsLab.vue  
3. Migrate RoughingIntentLab.vue  

**Short-term** (Next month):
1. Add CI legacy usage gate  
2. Expand coverage to remaining CAM endpoints  

**Medium-term** (Next quarter):
1. Add Compare endpoint helpers  
2. Add RMOS endpoint helpers  
3. Tighten TypeScript schemas  

---

**Document Version**: 1.0  
**Last Updated**: 2025-12-27  
**Status**: Phase 1 Complete, Ready for Phase 2  
**Next Review**: After Phase 2 completion  
