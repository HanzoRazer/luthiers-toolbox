# H8.3 SDK Migration Tracking

**Status**: ðŸš§ Foundation Complete, Component Migration Pending

## Definition of Done

### Phase 1: Foundation âœ… COMPLETE
- [x] Create `apiFetchRaw` transport layer with `{data, response}` return
- [x] Create CAM types with loose schemas for gradual tightening
- [x] Implement 3 initial endpoint helpers (roughing Ã— 2, pipeline Ã— 1)
- [x] Write comprehensive test suite with 100% pass rate
- [x] Document usage patterns in USAGE.md
- [x] Document architecture in endpoints/README.md
- [x] Update copilot-instructions.md with H8.3 pattern
- [x] Export endpoints from main SDK index

**Test Results**: âœ… 6/6 tests passing
```
âœ“ roughingGcode with X-CAM-Summary
âœ“ roughingGcode without X-CAM-Summary (graceful null)
âœ“ roughingGcode with malformed X-CAM-Summary (logs warning, returns null)
âœ“ roughingGcodeIntent with strict mode query param
âœ“ roughingGcodeIntent without strict mode
âœ“ runPipeline with FormData (no Content-Type override)
```

### Phase 2: Component Migration ðŸš§ IN PROGRESS
- [ ] Migrate CamPipelineRunner.vue to use `cam.runPipeline()`
- [ ] Migrate CAMEssentialsLab.vue to use `cam.roughingGcode()`
- [ ] Migrate RoughingIntentLab.vue to use `cam.roughingGcodeIntent()`
- [ ] Remove legacy fetch() calls from migrated components
- [ ] Update component tests to mock SDK helpers instead of fetch()

### Phase 3: CI Gate Integration ðŸ”® PLANNED
- [ ] Add frontend legacy usage gate to CI (see `services/api/app/ci/legacy_usage_gate.py`)
- [ ] Set initial budget to current usage count
- [ ] Run CI gate on every PR
- [ ] Track progress: Reduce budget as components migrate
- [ ] Goal: Budget = 0 (all components use SDK helpers)

### Phase 4: Coverage Expansion ðŸ”® PLANNED
- [ ] Add adaptive pocketing helpers (`cam.adaptivePocket()`)
- [ ] Add helical ramping helpers (`cam.helicalRamp()`)
- [ ] Add drilling pattern helpers (`cam.drillPattern()`)
- [ ] Add V-carve helpers (`cam.vcarve()`)
- [ ] Add compare endpoints (`compare.*`)
- [ ] Add RMOS endpoints (`rmos.*`)

### Phase 5: Schema Tightening ðŸ”® PLANNED
- [ ] Replace `unknown[]` with specific types as backend schemas stabilize
- [ ] Add Zod runtime validation for payloads
- [ ] Create endpoint-specific error types (e.g., `RoughingValidationError`)
- [ ] Add schema hash validation like CAM Intent (H7.1.1 pattern)

## Current Coverage

### CAM Endpoints (3)
| Endpoint | Helper | Status | Migration Target |
|----------|--------|--------|------------------|
| `POST /cam/roughing_gcode` | `cam.roughingGcode()` | âœ… Ready | CAMEssentialsLab.vue |
| `POST /cam/roughing_gcode_intent` | `cam.roughingGcodeIntent()` | âœ… Ready | RoughingIntentLab.vue |
| `POST /cam/pipeline/run` | `cam.runPipeline()` | âœ… Ready | CamPipelineRunner.vue |

### Component Inventory

**Known Legacy Usage:**
- [ ] `packages/client/src/components/CamPipelineRunner.vue` - Uses raw fetch() for pipeline
- [ ] `packages/client/src/components/CAMEssentialsLab.vue` - Uses raw fetch() for roughing
- [ ] `packages/client/src/views/RoughingIntentLab.vue` - Uses raw fetch() for intent endpoints
- [ ] `packages/client/src/views/DrillingLab.vue` - Uses legacy `/api/cam/drilling` (not yet migrated)
- [ ] `packages/client/src/views/BridgeLabView.vue` - Uses legacy rosette endpoints (not yet migrated)
- [ ] `packages/client/src/stores/useRosettePatternStore.ts` - Uses raw fetch() for rosette API

**CI Gate Detection**: Run `python -m app.ci.legacy_usage_gate --roots ../../packages/client/src --budget 10` to scan

## Migration Checklist Template

When migrating a component:

```markdown
### Component: [ComponentName.vue]

**Current State:**
- [ ] Component uses raw fetch() for API calls
- [ ] No type safety on payloads/responses
- [ ] Manual header parsing in component
- [ ] Manual request-id generation/extraction

**Migration Steps:**
1. [ ] Import SDK helper: `import { cam } from "@/sdk/endpoints"`
2. [ ] Replace fetch() with typed helper call
3. [ ] Remove manual header parsing logic
4. [ ] Update error handling to use `ApiError`
5. [ ] Add request-id to UI debug output
6. [ ] Update component tests to mock SDK helper
7. [ ] Test in browser (dev server)
8. [ ] Verify request-id propagation in Network tab

**After Migration:**
- [ ] Component uses typed SDK helper
- [ ] Type-safe payloads/responses
- [ ] Header parsing automatic (in helper)
- [ ] Consistent error handling with ApiError
- [ ] Request-id available for debugging
- [ ] Tests mock SDK helper, not fetch()
- [ ] No legacy fetch() calls remain
```

## Example Migrations

### Before: CamPipelineRunner.vue (Legacy)

```vue
<script setup lang="ts">
const runPipeline = async () => {
  const formData = new FormData();
  formData.append("config", JSON.stringify(config.value));
  formData.append("dxf_file", file.value);
  
  const requestId = generateRequestId();
  const response = await fetch("/api/cam/pipeline/run", {
    method: "POST",
    headers: {
      "X-Request-Id": requestId,
    },
    body: formData,
  });
  
  if (!response.ok) {
    const error = await response.json();
    throw new Error(error.detail || "Pipeline failed");
  }
  
  result.value = await response.json();
};
</script>
```

### After: CamPipelineRunner.vue (H8.3)

```vue
<script setup lang="ts">
import { cam } from "@/sdk/endpoints";
import { ApiError } from "@/sdk";

const runPipeline = async () => {
  const formData = new FormData();
  formData.append("config", JSON.stringify(config.value));
  formData.append("dxf_file", file.value);
  
  try {
    const { result: pipelineResult, requestId } = await cam.runPipeline(formData);
    result.value = pipelineResult;
    debugRequestId.value = requestId; // Show in UI for debugging
  } catch (err) {
    if (err instanceof ApiError) {
      console.error(`Pipeline failed [${err.status}]:`, err.message);
      console.error("Request ID:", err.details?.requestId);
      showErrorAlert(err.message);
    } else {
      throw err;
    }
  }
};
</script>
```

## Progress Tracking

**Date**: 2025-12-27
**Phase**: Foundation Complete âœ…
**Components Migrated**: 0 / 6
**Helpers Implemented**: 3 / TBD
**Test Coverage**: 6 tests passing

**Next Immediate Action**: Migrate CamPipelineRunner.vue as proof-of-concept

## CI Integration

### Legacy Usage Gate

Add to `.github/workflows/client_lint_build.yml`:

```yaml
- name: Frontend legacy usage gate
  working-directory: services/api
  env:
    LEGACY_USAGE_BUDGET: "10"  # Adjust as migration progresses
  run: |
    python -m app.ci.legacy_usage_gate \
      --roots "../../packages/client/src" "../../packages/sdk/src" \
      --budget ${LEGACY_USAGE_BUDGET}
```

**Current Budget**: Not yet enabled (set to 10 based on inventory)
**Goal**: Reduce to 0 as components migrate

## Documentation

- [SDK Endpoints README](../packages/client/src/sdk/endpoints/README.md) - Architecture overview
- [CAM USAGE.md](../packages/client/src/sdk/endpoints/cam/USAGE.md) - Usage examples
- [Copilot Instructions](./.github/copilot-instructions.md) - AI agent guidance (H8.3 section)
- [VITEST_QUICKREF.md](../packages/client/VITEST_QUICKREF.md) - Testing guide

## Questions / Blockers

None currently. Foundation is complete and ready for component migration.

## Notes

- **FormData handling**: Special case - browser must set Content-Type with multipart boundary
- **Header parsing**: `X-CAM-Summary` parser gracefully handles malformed JSON
- **Request-id**: All helpers include `requestId` in return shape for correlation
- **Error context**: ApiError includes request-id, status, url, details
- **Schema evolution**: Types are intentionally loose (e.g., `unknown[]`) to allow gradual tightening
