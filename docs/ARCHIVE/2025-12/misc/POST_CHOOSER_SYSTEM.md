# Post-Processor Chooser & Preview System

A self-contained add-on that provides:
- **Multi-select post-processor chooser** with localStorage persistence
- **Per-post preview drawer** showing headers/footers and first 20 lines of generated NC

## üéØ Features

### 1. **PostChooser Component**
Multi-select checkbox interface for choosing which post-processors to export to:
- Persists selection to `localStorage('toolbox.selectedPosts')`
- Defaults to first post (GRBL) if nothing saved
- "Reset" button to restore defaults
- "Preview" button per post to inspect headers/footers

### 2. **PostPreviewDrawer Component**
Side drawer for previewing post-processor output:
- Shows header and footer arrays from post config
- Renders first 20 lines of actual NC file using current G-code + units
- Real-time preview using `/api/geometry/export_gcode` endpoint

### 3. **Tooling API** (`/api/tooling/posts`)
New endpoint listing all available post-processors:
```json
[
  {
    "id": "grbl",
    "name": "grbl",
    "title": "GRBL CNC",
    "header": ["G90", "G17", "(GRBL 1.1)"],
    "footer": ["M30", "(End)"]
  },
  ...
]
```

## üìÅ New Files

```
services/api/app/routers/
  ‚îî‚îÄ‚îÄ tooling_router.py          # GET /api/tooling/posts endpoint

packages/client/src/components/
  ‚îú‚îÄ‚îÄ PostChooser.vue             # Multi-select with persistence
  ‚îî‚îÄ‚îÄ PostPreviewDrawer.vue       # Preview drawer with NC rendering
```

## üöÄ Usage

### In Your Vue Components

```vue
<template>
  <!-- Add to your geometry view -->
  <PostChooser v-model="selectedPosts" @preview="openPreview"/>
  <PostPreviewDrawer 
    v-model="drawerOpen" 
    :post-id="previewPostId" 
    :gcode="gcode" 
    :units="units"/>
</template>

<script setup lang="ts">
import PostChooser from './PostChooser.vue'
import PostPreviewDrawer from './PostPreviewDrawer.vue'

const selectedPosts = ref<string[]>(
  JSON.parse(localStorage.getItem('toolbox.selectedPosts') || '["GRBL"]')
)
const drawerOpen = ref(false)
const previewPostId = ref<string | null>(null)

function openPreview(id: string){
  previewPostId.value = id
  drawerOpen.value = true
}

// Use selectedPosts in multi-post exports
async function exportMultiPostBundle(){
  const posts = selectedPosts.value?.length ? selectedPosts.value : ['GRBL']
  const r = await fetch('/api/geometry/export_bundle_multi', {
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body: JSON.stringify({
      geometry: geometry.value,
      gcode: gcode.value,
      post_ids: posts,
      target_units: units.value
    })
  })
  downloadBlob(await r.blob(), 'ToolBox_Export_MultiPost.zip')
}
</script>
```

## üß™ Testing

### 1. Test API Endpoints
```powershell
# Start the API server
cd services/api
.\.venv\Scripts\Activate.ps1
uvicorn app.main:app --reload --port 8000

# Run tests
..\..\..\test_post_chooser.ps1
```

### 2. Test UI Components
```powershell
# Start the client
cd packages/client
npm run dev

# Open http://localhost:5173
# - Check/uncheck posts in PostChooser
# - Verify selection persists on page reload
# - Click "Preview" to see PostPreviewDrawer
# - Export multi-post bundle with selected posts
```

### 3. Verify localStorage Persistence
```javascript
// In browser console:
localStorage.getItem('toolbox.selectedPosts')
// => ["GRBL", "Mach4", "LinuxCNC"]

// Change selection and reload page - should restore
```

## üîß Configuration

### Adding New Post-Processors

1. Create JSON config in `services/api/app/data/posts/<name>.json`:
```json
{
  "header": [
    "G90",
    "G17",
    "(My Custom Post)"
  ],
  "footer": [
    "M30",
    "(Generated by ToolBox)"
  ]
}
```

2. Restart API server - new post appears in PostChooser automatically

### Customizing Titles

Edit `services/api/app/routers/tooling_router.py`:
```python
def _post_title(post_id: str) -> str:
    titles = {
        "grbl": "GRBL CNC",
        "mach4": "Mach4",
        "mycustom": "My Custom Controller"  # Add here
    }
    return titles.get(post_id.lower(), post_id.upper())
```

## üìä API Reference

### `GET /api/tooling/posts`
List all available post-processors.

**Response:**
```json
[
  {
    "id": "grbl",
    "name": "grbl",
    "title": "GRBL CNC",
    "header": ["G90", "G17"],
    "footer": ["M30"]
  }
]
```

### `GET /api/tooling/posts/{post_id}`
Get specific post-processor configuration.

**Response:**
```json
{
  "id": "grbl",
  "name": "grbl",
  "title": "GRBL CNC",
  "header": ["G90", "G17"],
  "footer": ["M30"]
}
```

## üé® UI Components

### PostChooser Props & Events

```typescript
// Props (v-model)
modelValue: string[]  // Array of selected post IDs

// Events
@update:modelValue  // Emits when selection changes
@preview           // Emits post ID when "Preview" clicked
```

### PostPreviewDrawer Props

```typescript
// Props
modelValue: boolean      // Open/close state
postId: string | null    // Post ID to preview
gcode: string           // Current G-code for preview
units: 'mm' | 'inch'    // Units for preview

// Events
@update:modelValue  // Emits when drawer closes
```

## üêõ Troubleshooting

### Posts Not Appearing
- Check API logs: `uvicorn app.main:app --reload --log-level debug`
- Verify JSON files exist in `services/api/app/data/posts/`
- Test endpoint directly: `curl http://localhost:8000/tooling/posts`

### localStorage Not Persisting
- Check browser console for errors
- Verify localStorage is enabled (not in private mode)
- Inspect value: `localStorage.getItem('toolbox.selectedPosts')`

### Preview Not Rendering
- Check network tab for `/api/geometry/export_gcode` request
- Verify post_id matches exactly (case-sensitive)
- Ensure gcode prop is valid G-code string

## üö¶ Integration Checklist

- [x] Create `tooling_router.py` with `/api/tooling/posts` endpoint
- [x] Register router in `main.py`
- [x] Create `PostChooser.vue` component
- [x] Create `PostPreviewDrawer.vue` component
- [x] Integrate into `GeometryOverlay.vue`
- [x] Update `exportMultiPostBundle()` to use `selectedPosts`
- [x] Add CI tests for `/api/tooling/posts` endpoint
- [x] Update `.github/copilot-instructions.md`
- [x] Create test script (`test_post_chooser.ps1`)

## üìö See Also

- [Multi-Post Export System](../PATCH_K_EXPORT_COMPLETE.md)
- [Unit Conversion](../services/api/app/util/units.py)
- [Post-Processor Configs](../services/api/app/data/posts/)
