{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "chladni_run.schema.json",
  "title": "Chladni Run Index",
  "type": "object",
  "additionalProperties": false,
  "properties": {
    "schema_id": { "const": "chladni_run" },
    "schema_version": { "type": "string", "pattern": "^[0-9]+\\.[0-9]+$" },

    "artifact_type": { "const": "chladni_run" },
    "created_utc": { "type": "string", "format": "date-time" },

    "plate_id": { "type": "string", "minLength": 1 },

    "environment": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "temp_C": { "type": ["number", "null"] },
        "rh_pct": { "type": ["number", "null"], "minimum": 0, "maximum": 100 }
      },
      "required": ["temp_C", "rh_pct"]
    },

    "excitation": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "mode": { "type": "string" }
      },
      "required": ["mode"]
    },

    "peaks_hz": {
      "type": "array",
      "items": { "type": "number", "exclusiveMinimum": 0 }
    },

    "patterns": {
      "type": "array",
      "items": {
        "type": "object",
        "additionalProperties": false,
        "properties": {
          "freq_hz": { "type": "number", "exclusiveMinimum": 0 },
          "image_path": { "type": "string", "minLength": 1 },
          "image_sha256": { "type": "string", "pattern": "^[a-f0-9]{64}$" },
          "image_freq_tag_hz": { "type": ["number", "null"], "exclusiveMinimum": 0 },
          "nearest_detected_hz": { "type": ["number", "null"], "exclusiveMinimum": 0 },
          "delta_hz": { "type": ["number", "null"], "minimum": 0 }
        },
        "required": ["freq_hz", "image_path", "image_sha256"]
      }
    },

    "provenance": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "peaks_json_path": { "type": "string" },
        "peaks_sha256": { "type": "string", "pattern": "^[a-f0-9]{64}$" },
        "mic_wav_path": { "type": ["string", "null"] },
        "mic_wav_sha256": { "type": ["string", "null"], "pattern": "^[a-f0-9]{64}$" }
      },
      "required": ["peaks_json_path", "peaks_sha256"]
    },

    "_policy": {
      "type": "object",
      "description": "Operational policy metadata (not part of core contract)",
      "properties": {
        "freq_tolerance_hz": { "type": "number", "minimum": 0 },
        "worst_delta_hz": { "type": "number", "minimum": 0 }
      }
    },
    "_warnings": {
      "type": "array",
      "description": "Non-fatal warnings from policy checks",
      "items": { "type": "string" }
    },
    "_errors": {
      "type": "array",
      "description": "Fatal errors from policy checks",
      "items": { "type": "string" }
    }
  },
  "required": [
    "schema_id", "schema_version",
    "artifact_type", "created_utc",
    "plate_id", "environment",
    "excitation", "peaks_hz", "patterns", "provenance"
  ]
}
