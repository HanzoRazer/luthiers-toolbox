name: pr-title-lint

on:
  pull_request:
    types: [opened, edited, synchronize, reopened]
    paths:
      - "contracts/schemas/*.schema.json"
      - "contracts/schema_registry.json"

jobs:
  lint:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout (full)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Enforce PR title format when schema files change
        shell: bash
        run: |
          set -euo pipefail
          TITLE="${{ github.event.pull_request.title }}"
          echo "PR title: $TITLE"
          # Only enforce when contracts/schemas changed in this PR
          base="${{ github.event.pull_request.base.sha }}"
          head="${{ github.sha }}"
          changed="$(git diff --name-only "$base...$head" | tr -s '\n')"
          echo "Changed files:"; echo "$changed"
          needs_check=$(echo "$changed" | grep -E '^contracts/schemas/[^/]+\.schema\.json$' || true)
          if [ -z "$needs_check" ]; then
            echo "No schema files changed; skipping title lint."
            exit 0
          fi
          # Require a clear, greppable prefix for release notes & audits
          if echo "$TITLE" | grep -qiE '^schema:\s'; then
            echo "✅ PR title matches required pattern."
            exit 0
          fi
          echo "❌ Schema files changed, but PR title is missing the required prefix."
          echo "   Please rename to start with:  schema: <short description>"
          exit 1
