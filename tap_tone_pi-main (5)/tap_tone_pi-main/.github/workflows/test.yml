# Pytest CI — Deterministic DSP & WAV I/O Tests
#
# This workflow runs the pytest suite for hardware-free, deterministic tests.
# It is part of the CI minimum bar defined in GOVERNANCE.md Section 8.

name: test

on:
  push:
    branches: [main]
    paths:
      - "**.py"
      - "tests/**"
      - "pyproject.toml"
  pull_request:
    branches: [main]
    paths:
      - "**.py"
      - "tests/**"
      - "pyproject.toml"

jobs:
  precommit:
    name: pre-commit
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Cache pre-commit env
        uses: actions/cache@v4
        with:
          path: ~/.cache/pre-commit
          key: precommit-${{ runner.os }}-${{ hashFiles('.pre-commit-config.yaml') }}
          restore-keys: |
            precommit-${{ runner.os }}-

      - name: Install pre-commit
        run: |
          python -m pip install --upgrade pip
          pip install pre-commit

      - name: Run pre-commit (all files)
        run: pre-commit run --all-files --show-diff-on-failure

  tests:
    needs: precommit
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ["3.10", "3.11"]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements-dev.txt
          # project deps used by tests
          pip install -r requirements.txt || true

      - name: Run tests
        run: pytest -q

      - name: Run hardware-free Chladni demo
        run: make examples-chladni-demo

      - name: Run hardware-free Phase-2 demo
        run: make examples-phase2-demo

      - name: Run hardware-free MOE demo
        run: make examples-moe-demo

      - name: Validate Analyzer schemas (out/**)
        run: make validate-schemas

      - name: ToolBox ingest smoke
        run: make toolbox-smoke

      - name: Verify WAV I/O tests pass
        run: |
          echo "WAV I/O tests are part of the CI minimum bar (Governance §8)"
          python -m pytest tests/test_wav_io.py tests/test_wav_io_roundtrip.py -v
