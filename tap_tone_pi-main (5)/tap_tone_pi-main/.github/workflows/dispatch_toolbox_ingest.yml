# ────────────────────────────────────────────────────────────────────────────────
# Dispatch ToolBox Ingest Smoke Tests on Analyzer Release
# ────────────────────────────────────────────────────────────────────────────────
#
# When a new analyzer-v* tag is pushed, dispatches to the ToolBox repo to trigger
# ingest smoke tests that validate cross-repo compatibility.
#
# Required secrets:
#   TOOLBOX_DISPATCH_TOKEN - Fine-grained PAT with "Contents: Read and write"
#                            permission for the ToolBox repo, OR a classic PAT
#                            with "repo" scope.
#
# Required variables:
#   TOOLBOX_REPO - The owner/repo of the ToolBox repo (e.g., HanzoRazer/luthiers-toolbox)
#
# ────────────────────────────────────────────────────────────────────────────────

name: Dispatch ToolBox Ingest

on:
  push:
    tags:
      - 'analyzer-v*'

  # Manual trigger for testing the dispatch mechanism
  workflow_dispatch:
    inputs:
      tag_override:
        description: "Tag to send (defaults to current ref for tag push)"
        required: false
        default: ""

jobs:
  notify-toolbox:
    name: Notify ToolBox on Analyzer release tag
    runs-on: ubuntu-latest
    env:
      TOOLBOX_REPO: ${{ vars.TOOLBOX_REPO }}
      ANALYZER_TAG: ${{ github.event.inputs.tag_override || github.ref_name }}
    steps:
      - name: Validate repo variable and tag format
        run: |
          set -euo pipefail
          if [ -z "${TOOLBOX_REPO:-}" ]; then
            echo "::error::TOOLBOX_REPO Actions Variable not set. Set it to owner/repo of the ToolBox repo."
            exit 1
          fi
          if [[ ! "${ANALYZER_TAG}" =~ ^analyzer-v[0-9]+\.[0-9]+\.[0-9]+(-rc[0-9]+)?$ ]]; then
            echo "::error::Tag does not match required pattern analyzer-vMAJOR.MINOR.PATCH[-rcN]: ${ANALYZER_TAG}"
            exit 1
          fi

      # Dry-run step: prints the resolved dispatch target before sending
      - name: Dry-run - echo dispatch target (no secrets)
        run: |
          echo "Dispatch target repo : ${TOOLBOX_REPO}"
          echo "Analyzer release tag : ${ANALYZER_TAG}"
          echo "Source repository    : ${GITHUB_REPOSITORY}"
          echo "Source commit SHA    : ${GITHUB_SHA}"
          echo "Triggered by actor   : ${GITHUB_ACTOR}"

      - name: Notify ToolBox via repository_dispatch (gh)
        env:
          GH_TOKEN: ${{ secrets.TOOLBOX_DISPATCH_TOKEN }}
        run: |
          if [ -z "${GH_TOKEN:-}" ]; then
            echo "::error::Missing secret TOOLBOX_DISPATCH_TOKEN in Analyzer repo."
            echo "   Create a PAT with permission to dispatch events to ${TOOLBOX_REPO}."
            exit 1
          fi
          echo "-> Dispatching analyzer-release to ${TOOLBOX_REPO} for ${ANALYZER_TAG}"
          # Build complete JSON body with jq and pipe through stdin
          jq -n \
            --arg tag "${ANALYZER_TAG}" \
            --arg by "${GITHUB_ACTOR}" \
            --arg sha "${GITHUB_SHA}" \
            '{event_type: "analyzer-release", client_payload: {analyzer_tag: $tag, triggered_by: $by, source_sha: $sha}}' | \
          gh api repos/${TOOLBOX_REPO}/dispatches \
            -X POST \
            -H "Accept: application/vnd.github+json" \
            --input -

      - name: Summary
        run: |
          echo "## Dispatch Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Field | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Tag | \`${ANALYZER_TAG}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Target Repo | ${TOOLBOX_REPO} |" >> $GITHUB_STEP_SUMMARY
          echo "| Event Type | \`analyzer-release\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Triggered By | ${GITHUB_ACTOR} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "The ToolBox repo should now run its **Analyzer Release Ingest Smoke** workflow." >> $GITHUB_STEP_SUMMARY
