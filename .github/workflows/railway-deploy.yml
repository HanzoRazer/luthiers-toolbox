# Railway Deployment Workflow
# ===========================
# Deploys API and Client services to Railway on push to main
#
# Required Secrets:
#   - RAILWAY_TOKEN: Railway API token (from Railway dashboard → Account → Tokens)
#
# Optional Secrets:
#   - SG_SPEC_TOKEN: GitHub token for private sg-spec repo access

name: Railway Deploy

on:
  push:
    branches: [main]
  workflow_dispatch:
    inputs:
      service:
        description: 'Service to deploy (api, client, or all)'
        required: true
        default: 'all'
        type: choice
        options:
          - all
          - api
          - client

env:
  RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}

jobs:
  deploy-api:
    name: Deploy API
    runs-on: ubuntu-latest
    if: github.event_name == 'push' || github.event.inputs.service == 'all' || github.event.inputs.service == 'api'

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Railway CLI
        run: npm install -g @railway/cli

      - name: Deploy API to Railway
        run: |
          cd services/api
          railway up --service api --environment production --detach
        env:
          RAILWAY_PROJECT_ID: 46251fb7-0c41-4400-88e7-2412859ddb5b

  deploy-client:
    name: Deploy Client
    runs-on: ubuntu-latest
    if: github.event_name == 'push' || github.event.inputs.service == 'all' || github.event.inputs.service == 'client'

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Railway CLI
        run: npm install -g @railway/cli

      - name: Deploy Client to Railway
        run: |
          cd packages/client
          railway up --service client --environment production --detach
        env:
          RAILWAY_PROJECT_ID: 46251fb7-0c41-4400-88e7-2412859ddb5b

  notify:
    name: Deployment Status
    runs-on: ubuntu-latest
    needs: [deploy-api, deploy-client]
    if: always()

    steps:
      - name: Check deployment status
        run: |
          if [ "${{ needs.deploy-api.result }}" == "success" ] && [ "${{ needs.deploy-client.result }}" == "success" ]; then
            echo "✅ All services deployed successfully!"
          elif [ "${{ needs.deploy-api.result }}" == "success" ]; then
            echo "⚠️ API deployed, but client deployment had issues"
          elif [ "${{ needs.deploy-client.result }}" == "success" ]; then
            echo "⚠️ Client deployed, but API deployment had issues"
          else
            echo "❌ Deployment failed for both services"
            exit 1
          fi
