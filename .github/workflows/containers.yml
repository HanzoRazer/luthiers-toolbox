name: Containers (Build + Smoke)
on:
  push:
  pull_request:

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    env:
      SERVER_PORT: 8000
      API_BASE: http://127.0.0.1:8000
      CLIENT_PORT: 8080
      API_IMAGE: toolbox/api:ci
      CLIENT_IMAGE: toolbox/client:ci
    steps:
      - uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build API image
        uses: docker/build-push-action@v6
        with:
          context: .
          file: docker/api/Dockerfile
          load: true
          tags: ${{ env.API_IMAGE }}
          build-args: |
            PYTHON_VERSION=3.11
            SG_SPEC_TOKEN=${{ secrets.SG_SPEC_TOKEN }}

      - name: Build Client image
        uses: docker/build-push-action@v6
        with:
          context: .
          file: docker/client/Dockerfile
          load: true
          tags: ${{ env.CLIENT_IMAGE }}
          build-args: |
            NODE_VERSION=20

      - name: Launch stack
        run: |
          cat > .env <<EOF
          SERVER_PORT=${SERVER_PORT}
          CLIENT_PORT=${CLIENT_PORT}
          CORS_ORIGINS=http://localhost:${CLIENT_PORT}
          API_IMAGE=${API_IMAGE}
          CLIENT_IMAGE=${CLIENT_IMAGE}
          COMPOSE_PROJECT_NAME=toolbox
          ART_STUDIO_DB_PATH=/tmp/art_studio.db
          EOF
          docker compose up -d
          # wait for health
          for i in $(seq 1 30); do
            docker compose ps
            curl -fsS http://127.0.0.1:${SERVER_PORT}/health && break || sleep 2
          done

      - name: Smoke - Health check
        run: |
          curl -fsS http://127.0.0.1:${SERVER_PORT}/health | jq .

      - name: Smoke - Simulate sample program with arcs
        run: |
          python - <<'PY'
          import urllib.request, json
          gcode = "G21 G90 G17 F1200\nG0 Z5\nG0 X0 Y0\nG1 Z-1 F300\nG2 X60 Y40 I0 J20\nG0 Z5\n"
          import os
          req = urllib.request.Request(f"{os.environ['API_BASE']}/api/sim/cam/simulate_gcode",
                                       data=json.dumps({"gcode":gcode}).encode(),
                                       headers={"Content-Type":"application/json"})
          resp = urllib.request.urlopen(req)
          data = resp.read().decode()
          print(data)
          # Check for arc move
          import json as j
          result = j.loads(data)
          assert any(m.get('code') == 'G2' for m in result.get('moves', [])), "No G2 arc found!"
          print("âœ“ Arc simulation working")
          PY

      - name: Smoke - Tooling endpoints
        run: |
          echo "Testing post-processors..."
          curl -fsS http://127.0.0.1:${SERVER_PORT}/api/tooling/posts | jq .
          
          echo "Testing tool library..."
          curl -fsS http://127.0.0.1:${SERVER_PORT}/api/tooling/library/tools | jq '.[0:3]'
          
          echo "Testing material library..."
          curl -fsS http://127.0.0.1:${SERVER_PORT}/api/tooling/library/materials | jq '.[0:3]'
          
          echo "Testing feeds/speeds calculation..."
          curl -fsS -X POST http://127.0.0.1:${SERVER_PORT}/api/feeds/calculate \
            -H 'Content-Type: application/json' \
            -d '{"tool_d":6.0,"chipload":0.15,"flutes":2,"rpm":15000}' | jq .

      - name: Smoke - Client container
        run: |
          echo "Testing client container..."
          curl -fsS http://127.0.0.1:${CLIENT_PORT}/ | grep "Luthier's Tool Box"
          
          echo "Testing API proxy through client..."
          curl -fsS http://127.0.0.1:${CLIENT_PORT}/health | jq .

      - name: Show logs on failure
        if: failure()
        run: |
          docker compose logs api
          docker compose logs client

      - name: Tear down
        if: always()
        run: docker compose down -v
