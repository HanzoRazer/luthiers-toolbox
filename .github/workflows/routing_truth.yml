name: routing-truth

on:
  pull_request:
  push:
    branches: [ main ]

jobs:
  routing-truth:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: services/api
    env:
      PYTHONUNBUFFERED: "1"
      # Fail-fast lanes (override in repo if needed)
      ROUTING_TRUTH_FAIL_LANES: "CORE,META,OPERATION,RMOS"
      ROUTING_TRUTH_WARN_ON_UNDOC: "true"
      ROUTING_TRUTH_FAIL_ON_UNDOC: "false"
      ROUTING_TRUTH_API_URL: "http://127.0.0.1:8000"
      ROUTING_TRUTH_TRUTH_FILE: "services/api/app/data/endpoint_truth.json"
      # Optional override if your endpoint differs:
      # ROUTING_TRUTH_ENDPOINT_PATH: "/api/_meta/routing-truth"
      # Keep tests & boot deterministic (matches your global isolation defaults)
      RMOS_RUN_ATTACHMENTS_DIR: "${{ runner.temp }}/rmos_test_attachments"
      RMOS_ARTIFACT_ROOT: "${{ runner.temp }}/rmos_artifacts"
      SAW_LAB_LEARNED_OVERRIDES_PATH: "${{ runner.temp }}/saw_overrides.jsonl"
      DATABASE_URL: "sqlite:///${{ runner.temp }}/routing_truth_ci.sqlite"

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install API dependencies
        run: |
          python -m pip install --upgrade pip
          # Allow override when repo uses a custom install pattern
          if [ -n "${PIP_INSTALL_CMD:-}" ]; then
            echo "Using PIP_INSTALL_CMD override: $PIP_INSTALL_CMD"
            eval "$PIP_INSTALL_CMD"
          elif [ -f pyproject.toml ]; then
            pip install -e .
          elif [ -f requirements.txt ]; then
            pip install -r requirements.txt
          else
            echo "No pyproject.toml or requirements.txt found in services/api; adjust workflow."
            exit 1
          fi
          pip install uvicorn

      - name: Start API (background)
        run: |
          mkdir -p "$RMOS_RUN_ATTACHMENTS_DIR" "$RMOS_ARTIFACT_ROOT"
          # Prefer app.main:create_app pattern if present; fallback to app.main:app.
          # You can standardize this later; this keeps CI resilient.
          (uvicorn app.main:app --host 127.0.0.1 --port 8000 --log-level warning) &
          echo $! > /tmp/uvicorn_pid

      - name: Wait for routing-truth endpoint (auto-detect)
        run: |
          python - <<'PY'
          import time, urllib.request
          base="http://127.0.0.1:8000"
          paths=[
            "/api/_meta/routing-truth",
            "/meta/router-truth",
            "/api/meta/router-truth",
          ]
          for i in range(80):
            for p in paths:
              url=base+p
              try:
                with urllib.request.urlopen(url, timeout=1.5) as r:
                  if r.status == 200:
                    print("OK:", url)
                    raise SystemExit(0)
              except Exception:
                pass
            time.sleep(0.4)
          raise SystemExit("API did not become ready for any routing-truth endpoint (tried: %s)" % paths)
          PY

      - name: Run routing truth gate
        run: |
          python scripts/check_routing_truth.py

      - name: Stop API
        if: always()
        run: |
          if [ -f /tmp/uvicorn_pid ]; then
            kill "$(cat /tmp/uvicorn_pid)" || true
          fi
