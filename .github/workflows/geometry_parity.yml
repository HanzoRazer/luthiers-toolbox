name: Geometry Parity (Patch K)

on: [push, pull_request]

jobs:
  geometry-parity:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      

      - name: Configure git for private repos
        run: |
          git config --global url."https://${{ secrets.SG_SPEC_TOKEN }}@github.com/".insteadOf "https://github.com/"

      - name: Install API dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r services/api/requirements.txt
      
      - name: Boot API server
        run: |
          cd services/api && uvicorn app.main:app --host 127.0.0.1 --port 8000 &
          for i in $(seq 1 30); do
            curl -sSf http://127.0.0.1:8000/health >/dev/null && exit 0 || sleep 1
          done
          echo "API server failed to start"
          exit 1
      
      - name: Test geometry import (JSON)
        run: |
          python - <<'PY'
          import urllib.request, json
          geometry = {
            "units": "mm",
            "paths": [
              {"type": "line", "x1": 0, "y1": 0, "x2": 60, "y2": 0},
              {"type": "arc", "cx": 30, "cy": 20, "r": 20, "start": 180, "end": 0, "cw": False}
            ]
          }
          url = "http://127.0.0.1:8000/api/geometry/import"
          req = urllib.request.Request(
            url, 
            data=json.dumps({"geometry": geometry}).encode(),
            headers={"Content-Type": "application/json"}
          )
          response = urllib.request.urlopen(req).read().decode()
          print("Import response:", response)
          result = json.loads(response)
          assert "paths" in result, "Import failed: no paths in response"
          print("✓ Geometry import test passed")
          PY
      
      - name: Test parity check
        run: |
          python - <<'PY'
          import urllib.request, json
          # Simple rectangle: geometry and G-code describe the same shape
          geometry = {
            "units": "mm",
            "paths": [
              {"type": "line", "x1": 0, "y1": 0, "x2": 100, "y2": 0},
              {"type": "line", "x1": 100, "y1": 0, "x2": 100, "y2": 50},
              {"type": "line", "x1": 100, "y1": 50, "x2": 0, "y2": 50},
              {"type": "line", "x1": 0, "y1": 50, "x2": 0, "y2": 0}
            ]
          }
          gcode = "G21 G90 G17 F1200\nG0 Z5\nG0 X0 Y0\nG1 Z-1 F300\nG1 X100 Y0\nG1 X100 Y50\nG1 X0 Y50\nG1 X0 Y0\nG0 Z5\n"
          url = "http://127.0.0.1:8000/api/geometry/parity"
          payload = {"geometry": geometry, "gcode": gcode, "tolerance_mm": 0.1}
          req = urllib.request.Request(url, data=json.dumps(payload).encode(), headers={"Content-Type": "application/json"})
          response = urllib.request.urlopen(req).read().decode()
          print("Parity response:", response)
          result = json.loads(response)
          assert "rms_error_mm" in result, "Missing rms_error_mm"
          assert "max_error_mm" in result, "Missing max_error_mm"
          assert "pass" in result, "Missing pass field"
          print("RMS Error: " + str(result["rms_error_mm"]) + " mm")
          print("Max Error: " + str(result["max_error_mm"]) + " mm")
          print("Tolerance: " + str(result["tolerance_mm"]) + " mm")
          print("Pass: " + str(result["pass"]))
          assert result["pass"], "Parity check failed"
          print("✓ Parity check test passed")
          PY
