name: Smart Guitar Export Gate

on:
  pull_request:
    paths:
      - 'contracts/**'
      - 'services/api/app/smart_guitar_export/**'
      - 'services/api/tests/test_smart_guitar_export_gate.py'
      - '.github/workflows/smart_guitar_export_gate.yml'
  push:
    branches:
      - main
      - develop
    paths:
      - 'contracts/**'
      - 'services/api/app/smart_guitar_export/**'
      - 'services/api/tests/test_smart_guitar_export_gate.py'
      - '.github/workflows/smart_guitar_export_gate.yml'

jobs:
  smart-guitar-export-gate:
    name: Smart Guitar Export Boundary Gate
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        working-directory: services/api
        run: |
          python -m pip install --upgrade pip
          pip install pydantic pytest

      - name: Validate JSON Schema is valid
        run: |
          python -c "
          import json
          with open('contracts/toolbox_smart_guitar_safe_export_v1.schema.json') as f:
              schema = json.load(f)
          assert schema.get('\$schema'), 'Missing \$schema'
          assert schema.get('title'), 'Missing title'
          print('✓ Schema is valid JSON')
          "

      - name: Run export gate tests
        working-directory: services/api
        env:
          PYTHONPATH: .
        run: |
          python -m pytest tests/test_smart_guitar_export_gate.py -v --tb=short

  smart-guitar-export-summary:
    name: Export Gate Summary
    runs-on: ubuntu-latest
    needs: smart-guitar-export-gate
    if: always()

    steps:
      - name: Report status
        run: |
          echo "## Smart Guitar Export Gate Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ needs.smart-guitar-export-gate.result }}" == "success" ]; then
            echo "✅ All export boundary checks passed" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Contract: TOOLBOX_SMART_GUITAR_EXPORT_v1" >> $GITHUB_STEP_SUMMARY
            echo "- no_manufacturing: ✓" >> $GITHUB_STEP_SUMMARY
            echo "- no_toolpaths: ✓" >> $GITHUB_STEP_SUMMARY
            echo "- no_rmos_authority: ✓" >> $GITHUB_STEP_SUMMARY
            echo "- no_secrets: ✓" >> $GITHUB_STEP_SUMMARY
          else
            echo "❌ Export boundary violations detected" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "The Smart Guitar export must NOT contain:" >> $GITHUB_STEP_SUMMARY
            echo "- G-code, CAM, DXF, toolpaths" >> $GITHUB_STEP_SUMMARY
            echo "- RMOS artifacts, run IDs, decisions" >> $GITHUB_STEP_SUMMARY
            echo "- Secrets (API keys, tokens)" >> $GITHUB_STEP_SUMMARY
          fi
