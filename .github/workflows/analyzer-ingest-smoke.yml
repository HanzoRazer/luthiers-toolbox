name: analyzer-ingest-smoke

on:
  # Manual run with explicit Analyzer release tag (e.g., analyzer-v1.0.0)
  workflow_dispatch:
    inputs:
      analyzer_tag:
        description: "Analyzer release tag (e.g., analyzer-v1.0.0)"
        required: true
        type: string
  # Allow Analyzer repo to ping this workflow via repository_dispatch
  repository_dispatch:
    types: [analyzer-release]

jobs:
  smoke:
    runs-on: ubuntu-latest
    env:
      # Set this in Actions → Variables in ToolBox if your org/repo differs.
      ANALYZER_REPO: ${{ vars.ANALYZER_REPO || 'HanzoRazer/tap_tone_pi' }}
      # Prefer the manual input; otherwise accept a repository_dispatch payload.
      ANALYZER_REF:  ${{ inputs.analyzer_tag || github.event.client_payload.analyzer_tag || '' }}
    steps:
      - name: Checkout ToolBox (this repo)
        uses: actions/checkout@v4

      - name: Validate analyzer_tag (must be analyzer-v*)
        if: env.ANALYZER_REF == ''
        run: |
          echo "❌ Missing analyzer tag. Provide via workflow_dispatch input 'analyzer_tag' or repository_dispatch payload."
          exit 1

      - name: Validate tag pattern
        run: |
          set -euo pipefail
          TAG="${{ env.ANALYZER_REF }}"
          echo "Analyzer tag: $TAG"
          if [[ ! "$TAG" =~ ^analyzer-v[0-9]+\.[0-9]+\.[0-9]+(-rc[0-9]+)?$ ]]; then
            echo "❌ Tag does not match required pattern: analyzer-vMAJOR.MINOR.PATCH[-rcN]"
            exit 1
          fi

      - name: Checkout Analyzer repo (read-only)
        uses: actions/checkout@v4
        with:
          repository: ${{ env.ANALYZER_REPO }}
          ref: ${{ env.ANALYZER_REF }}
          path: analyzer
          token: ${{ secrets.ANALYZER_REPO_TOKEN }}

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps (jsonschema + minimal numpy/scipy for Analyzer demos)
        run: |
          python -m pip install --upgrade pip
          pip install jsonschema numpy scipy

      - name: Generate Analyzer demo artifacts (hardware-free)
        run: |
          make -C analyzer examples-chladni-demo
          make -C analyzer examples-phase2-demo
          make -C analyzer examples-moe-demo

      - name: Run ToolBox ingest smoke
        run: |
          python scripts/analyzer_ingest_smoke.py \
            --contracts-root analyzer/contracts \
            --chladni-dir   analyzer/out/DEMO/chladni \
            --phase2-dir    analyzer/runs_phase2/DEMO/session_0001 \
            --moe-dir       analyzer/out/DEMO/moe
