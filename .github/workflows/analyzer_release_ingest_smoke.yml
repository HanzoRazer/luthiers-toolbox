# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Analyzer Release Ingest Smoke Tests
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
#
# Triggered by repository_dispatch from the Analyzer repo (tap_tone_pi) when a new
# Analyzer release tag (analyzer-v*) is pushed. Validates that ToolBox can correctly
# ingest artifacts produced by the new Analyzer version.
#
# Also supports manual triggering for testing/validation.
#
# Required secrets in Analyzer repo:
#   TOOLBOX_DISPATCH_TOKEN - PAT with repo dispatch permission for this repo
#
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

name: Analyzer Release Ingest Smoke

on:
  repository_dispatch:
    types: [analyzer-release]
  
  # Manual trigger for testing
  workflow_dispatch:
    inputs:
      analyzer_tag:
        description: "Analyzer tag to test against (e.g., analyzer-v1.2.0)"
        required: false
        default: "manual-test"
      run_full_suite:
        description: "Run full test suite (not just smoke)"
        type: boolean
        default: false

env:
  PYTHON_VERSION: "3.11"
  # Extracted from dispatch payload or workflow_dispatch input
  ANALYZER_TAG: ${{ github.event.client_payload.analyzer_tag || github.event.inputs.analyzer_tag || 'unknown' }}

jobs:
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # Pre-flight: Validate dispatch payload and log context
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  preflight:
    name: "Pre-flight Check"
    runs-on: ubuntu-latest
    outputs:
      analyzer_tag: ${{ steps.extract.outputs.tag }}
      is_manual: ${{ steps.extract.outputs.is_manual }}
      run_full: ${{ steps.extract.outputs.run_full }}
    steps:
      - name: Extract and validate payload
        id: extract
        run: |
          TAG="${{ github.event.client_payload.analyzer_tag || github.event.inputs.analyzer_tag || 'unknown' }}"
          IS_MANUAL="${{ github.event_name == 'workflow_dispatch' && 'true' || 'false' }}"
          RUN_FULL="${{ github.event.inputs.run_full_suite || 'false' }}"
          
          echo "tag=$TAG" >> $GITHUB_OUTPUT
          echo "is_manual=$IS_MANUAL" >> $GITHUB_OUTPUT
          echo "run_full=$RUN_FULL" >> $GITHUB_OUTPUT
          
          echo "## ðŸ”” Analyzer Release Ingest Smoke" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Field | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Analyzer Tag | \`$TAG\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Trigger | ${{ github.event_name }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Manual | $IS_MANUAL |" >> $GITHUB_STEP_SUMMARY
          echo "| Full Suite | $RUN_FULL |" >> $GITHUB_STEP_SUMMARY
          echo "| Workflow Run | [${{ github.run_id }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}) |" >> $GITHUB_STEP_SUMMARY

      - name: Validate tag format (if not manual)
        if: github.event_name == 'repository_dispatch'
        run: |
          TAG="${{ steps.extract.outputs.tag }}"
          if [[ ! "$TAG" =~ ^analyzer-v[0-9]+\.[0-9]+\.[0-9]+ ]]; then
            echo "::warning::Tag '$TAG' does not match expected format 'analyzer-vX.Y.Z'"
          fi

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # Core Ingest Smoke Tests
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  ingest-smoke:
    name: "Ingest Smoke Tests"
    runs-on: ubuntu-latest
    needs: preflight
    timeout-minutes: 15
    
    services:
      # Optional: If tests need a database
      postgres:
        image: postgres:15-alpine
        env:
          POSTGRES_USER: test
          POSTGRES_PASSWORD: test
          POSTGRES_DB: toolbox_test
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout ToolBox
        uses: actions/checkout@v4

      - name: Set up Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Cache pip dependencies
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('services/api/requirements*.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Install dependencies
        working-directory: services/api
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest pytest-timeout pytest-cov

      - name: Verify test markers exist
        working-directory: services/api
        run: |
          # Check that acoustics/ingest markers are defined
          python -c "
          import pytest
          import sys
          
          # Load pytest.ini markers
          ini_path = 'pytest.ini'
          with open(ini_path) as f:
              content = f.read()
          
          markers = ['acoustics', 'ingest']
          missing = [m for m in markers if m not in content]
          
          if missing:
              print(f'::warning::Missing pytest markers: {missing}')
              print('Tests may not filter correctly.')
          else:
              print('âœ“ All expected markers found in pytest.ini')
          "

      - name: Run Acoustics Ingest Smoke Tests
        id: smoke
        working-directory: services/api
        env:
          ANALYZER_TAG: ${{ needs.preflight.outputs.analyzer_tag }}
          DATABASE_URL: postgresql://test:test@localhost:5432/toolbox_test
          PYTHONPATH: .
        run: |
          echo "Running ingest smoke tests for Analyzer $ANALYZER_TAG..."
          
          # Determine test scope
          if [[ "${{ needs.preflight.outputs.run_full }}" == "true" ]]; then
            MARKERS="acoustics or ingest"
            echo "::notice::Running FULL test suite (acoustics + ingest)"
          else
            MARKERS="smoke and (acoustics or ingest)"
            echo "::notice::Running SMOKE tests only"
          fi
          
          # Run tests with coverage
          python -m pytest tests/ \
            -v \
            -m "$MARKERS" \
            --tb=short \
            --timeout=120 \
            --junitxml=test-results.xml \
            --cov=app.rmos \
            --cov-report=term-missing \
            --cov-report=xml:coverage.xml \
            2>&1 | tee test-output.log
          
          EXIT_CODE=${PIPESTATUS[0]}
          
          # Extract summary stats
          PASSED=$(grep -oP '\d+(?= passed)' test-output.log | head -1 || echo "0")
          FAILED=$(grep -oP '\d+(?= failed)' test-output.log | head -1 || echo "0")
          SKIPPED=$(grep -oP '\d+(?= skipped)' test-output.log | head -1 || echo "0")
          
          echo "passed=$PASSED" >> $GITHUB_OUTPUT
          echo "failed=$FAILED" >> $GITHUB_OUTPUT
          echo "skipped=$SKIPPED" >> $GITHUB_OUTPUT
          echo "exit_code=$EXIT_CODE" >> $GITHUB_OUTPUT
          
          exit $EXIT_CODE

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results-${{ needs.preflight.outputs.analyzer_tag }}
          path: |
            services/api/test-results.xml
            services/api/coverage.xml
            services/api/test-output.log
          retention-days: 30

      - name: Generate test summary
        if: always()
        run: |
          TAG="${{ needs.preflight.outputs.analyzer_tag }}"
          PASSED="${{ steps.smoke.outputs.passed || '0' }}"
          FAILED="${{ steps.smoke.outputs.failed || '0' }}"
          SKIPPED="${{ steps.smoke.outputs.skipped || '0' }}"
          EXIT="${{ steps.smoke.outputs.exit_code || '1' }}"
          
          if [[ "$EXIT" == "0" ]]; then
            STATUS="âœ… PASSED"
            ICON="ðŸŽ‰"
          else
            STATUS="âŒ FAILED"
            ICON="ðŸš¨"
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## $ICON Ingest Smoke Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Metric | Count |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Passed | $PASSED |" >> $GITHUB_STEP_SUMMARY
          echo "| Failed | $FAILED |" >> $GITHUB_STEP_SUMMARY
          echo "| Skipped | $SKIPPED |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Status:** $STATUS" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Analyzer Tag:** \`$TAG\`" >> $GITHUB_STEP_SUMMARY

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # Boundary Contract Validation
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  boundary-check:
    name: "Boundary Contract Check"
    runs-on: ubuntu-latest
    needs: preflight
    timeout-minutes: 5
    
    steps:
      - name: Checkout ToolBox
        uses: actions/checkout@v4

      - name: Set up Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install minimal dependencies
        working-directory: services/api
        run: |
          pip install --upgrade pip
          # Install only what's needed for boundary check
          pip install pydantic

      - name: Run boundary import check
        working-directory: services/api
        run: |
          echo "Verifying ToolBox does not import Analyzer internals..."
          python -m app.ci.check_boundary_imports --profile toolbox
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸ”’ Boundary Check" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… No forbidden imports from Analyzer codebase detected." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ToolBox correctly consumes Analyzer **artifacts** (JSON/CSV/WAV)," >> $GITHUB_STEP_SUMMARY
          echo "not Analyzer **code** (\`tap_tone.*\`, \`modes.*\`)." >> $GITHUB_STEP_SUMMARY

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # Artifact Schema Compatibility Check
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  schema-compat:
    name: "Artifact Schema Compatibility"
    runs-on: ubuntu-latest
    needs: preflight
    timeout-minutes: 10
    
    steps:
      - name: Checkout ToolBox
        uses: actions/checkout@v4

      - name: Set up Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        working-directory: services/api
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt

      - name: Validate artifact schemas
        working-directory: services/api
        env:
          ANALYZER_TAG: ${{ needs.preflight.outputs.analyzer_tag }}
        run: |
          echo "Validating ToolBox can parse Analyzer artifact schemas..."
          
          # Run schema validation tests
          python -m pytest tests/ \
            -v \
            -m "schema" \
            --tb=short \
            -x \
            2>&1 || true
          
          # Also run the contract validator if it exists
          if [[ -f "../../scripts/governance/validate_run_artifact_contract.py" ]]; then
            echo "Running artifact contract validator..."
            python ../../scripts/governance/validate_run_artifact_contract.py || true
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸ“‹ Schema Compatibility" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Artifact schema validation completed for Analyzer \`$ANALYZER_TAG\`." >> $GITHUB_STEP_SUMMARY

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # Final Status Report
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  report:
    name: "Final Report"
    runs-on: ubuntu-latest
    needs: [preflight, ingest-smoke, boundary-check, schema-compat]
    if: always()
    
    steps:
      - name: Determine overall status
        id: status
        run: |
          SMOKE="${{ needs.ingest-smoke.result }}"
          BOUNDARY="${{ needs.boundary-check.result }}"
          SCHEMA="${{ needs.schema-compat.result }}"
          
          if [[ "$SMOKE" == "success" && "$BOUNDARY" == "success" ]]; then
            OVERALL="success"
            EMOJI="âœ…"
            MSG="All checks passed"
          elif [[ "$SMOKE" == "failure" || "$BOUNDARY" == "failure" ]]; then
            OVERALL="failure"
            EMOJI="âŒ"
            MSG="Critical checks failed"
          else
            OVERALL="warning"
            EMOJI="âš ï¸"
            MSG="Some checks skipped or had warnings"
          fi
          
          echo "overall=$OVERALL" >> $GITHUB_OUTPUT
          echo "emoji=$EMOJI" >> $GITHUB_OUTPUT
          echo "msg=$MSG" >> $GITHUB_OUTPUT

      - name: Generate final summary
        run: |
          TAG="${{ needs.preflight.outputs.analyzer_tag }}"
          EMOJI="${{ steps.status.outputs.emoji }}"
          MSG="${{ steps.status.outputs.msg }}"
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## $EMOJI Final Status: $MSG" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Pre-flight | ${{ needs.preflight.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Ingest Smoke | ${{ needs.ingest-smoke.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Boundary Check | ${{ needs.boundary-check.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Schema Compat | ${{ needs.schema-compat.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Analyzer Tag:** \`$TAG\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Triggered by:** ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "*Workflow: analyzer_release_ingest_smoke.yml*" >> $GITHUB_STEP_SUMMARY

      - name: Fail if critical checks failed
        if: needs.ingest-smoke.result == 'failure' || needs.boundary-check.result == 'failure'
        run: |
          echo "::error::Critical checks failed. See job summaries for details."
          exit 1
