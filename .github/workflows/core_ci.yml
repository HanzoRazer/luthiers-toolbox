name: Core CI (Consolidated)

on:
  push:
  pull_request:
  workflow_dispatch:

env:
  PYTHONUNBUFFERED: "1"

jobs:
  api-tests:
    name: API Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      - name: Configure git for private repos
        run: |
          git config --global url."https://${{ secrets.SG_SPEC_TOKEN }}@github.com/".insteadOf "https://github.com/"
      - name: Install API dependencies
        run: |
          python -m pip install --upgrade pip
          python -m pip install -r services/api/requirements.txt
      - name: Art Studio Scope Gate
        run: |
          python scripts/ci/check_art_studio_scope.py --repo-root .
      - name: Viewer Pack v1 Schema Parity Gate
        run: |
          python scripts/validate/check_viewer_pack_schema_parity.py --mode check
      - name: CONTRACTS_GOVERNANCE_SCENARIO_B_GATE
        run: |
          python scripts/ci/check_contracts_governance.py --base-ref origin/main
      - name: Boot API
        run: |
          cd services/api
          uvicorn app.main:app --host 127.0.0.1 --port 8000 &
          for i in $(seq 1 40); do
            curl -fsS http://127.0.0.1:8000/api/health >/dev/null && exit 0 || sleep 1
          done
          exit 1
      - name: Run pytest
        run: |
          cd services/api
          python -m pytest -q

  geometry-parity:
    name: Geometry Parity
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      - name: Configure git for private repos
        run: |
          git config --global url."https://${{ secrets.SG_SPEC_TOKEN }}@github.com/".insteadOf "https://github.com/"
      - name: Install API dependencies
        run: |
          python -m pip install --upgrade pip
          python -m pip install -r services/api/requirements.txt
      - name: Boot API
        run: |
          cd services/api
          uvicorn app.main:app --host 127.0.0.1 --port 8000 &
          for i in $(seq 1 40); do
            curl -fsS http://127.0.0.1:8000/api/health >/dev/null && exit 0 || sleep 1
          done
          exit 1
      - name: Parity check
        run: |
          python - <<'PY'
          import urllib.request, json
          base_url = "http://127.0.0.1:8000"
          # Simple 100x60mm rectangle (4 line segments)
          geometry = {
            "units":"mm",
            "paths":[
              {"type":"line","x1":0,"y1":0,"x2":100,"y2":0},
              {"type":"line","x1":100,"y1":0,"x2":100,"y2":60},
              {"type":"line","x1":100,"y1":60,"x2":0,"y2":60},
              {"type":"line","x1":0,"y1":60,"x2":0,"y2":0}
            ]
          }
          # G-code that matches the rectangle geometry
          gcode = "G21 G90\nG0 X0 Y0\nG1 X100 Y0 F1200\nG1 X100 Y60\nG1 X0 Y60\nG1 X0 Y0\nM30"
          url = f"{base_url}/api/geometry/parity"
          req = urllib.request.Request(url, data=json.dumps({"geometry":geometry,"gcode":gcode,"tolerance_mm":0.1}).encode(), headers={"Content-Type":"application/json"})
          out = urllib.request.urlopen(req).read().decode()
          result = json.loads(out)
          assert result.get("pass") is True, f"Parity check failed: {result}"
          print("âœ“ Geometry parity passed", result)
          PY

  containers-smoke:
    name: Containers (Build + Smoke)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Write .env for compose
        run: |
          cat > .env <<EOF
          SERVER_PORT=8000
          CLIENT_PORT=8080
          FRONT_PORT=8088
          CORS_ORIGINS=http://localhost:8088
          COMPOSE_PROJECT_NAME=toolbox
          API_IMAGE=toolbox/api:ci
          CLIENT_IMAGE=toolbox/client:ci
          PROXY_IMAGE=toolbox/nginx:ci
          EOF
      - name: Build API
        uses: docker/build-push-action@v6
        with:
          context: .
          file: docker/api/Dockerfile
          load: true
          tags: toolbox/api:ci
          build-args: |
            SG_SPEC_TOKEN=${{ secrets.SG_SPEC_TOKEN }}
      - name: Build Client
        uses: docker/build-push-action@v6
        with:
          context: .
          file: docker/client/Dockerfile
          load: true
          tags: toolbox/client:ci
      - name: Build Front Proxy (nginx)
        uses: docker/build-push-action@v6
        with:
          context: .
          file: docker/nginx/Dockerfile
          load: true
          tags: toolbox/nginx:ci
      - name: Up stack
        run: docker compose --profile proxy up -d
      - name: Wait for API via proxy
        run: |
          for i in $(seq 1 40); do
            curl -fsS http://127.0.0.1:8088/api/health && exit 0 || sleep 2
          done
          echo "API did not become healthy via proxy" >&2
          docker compose --profile proxy ps
          docker compose --profile proxy logs --no-color --tail=200 api proxy || true
          exit 1

  summary:
    name: Core CI Summary
    runs-on: ubuntu-latest
    needs: [api-tests, geometry-parity, containers-smoke]
    if: always()
    steps:
      - name: Write consolidated status
        run: |
          {
            echo "## Core CI Status"
            echo ""
            echo "| Job | Result |"
            echo "|---|---|"
            echo "| API Tests | ${{ needs.api-tests.result }} |"
            echo "| Geometry Parity | ${{ needs.geometry-parity.result }} |"
            echo "| Containers Smoke | ${{ needs.containers-smoke.result }} |"
            echo ""
          } >> $GITHUB_STEP_SUMMARY

      - name: Fail if any core job failed
        if: ${{ contains(join(needs.*.result, ','), 'failure') || contains(join(needs.*.result, ','), 'cancelled') }}
        run: exit 1
