{
  "schema_version": "cbsp21_patch_input_v1",
  "patch_id": "ROUTING_TRUTH_GATE_V1",
  "title": "Routing Truth CI Gate - Offline Import Version",
  "intent": "Enforce that endpoint_truth.json matches the live FastAPI routing table via direct app import (no server startup required), supporting deprecated routes with sunset dates and LEGACY lane handling.",
  "change_type": "ci",
  "behavior_change": "compatible",
  "risk_level": "medium",
  "scope": {
    "repo_root": ".",
    "paths_in_scope": [
      "services/api/app/data/",
      "services/api/app/ci/",
      "services/api/",
      "scripts/governance/",
      "scripts/ci/",
      ".github/workflows/"
    ],
    "files_expected_to_change": [
      ".cbsp21/patch_input.json",
      "scripts/governance/check_routing_truth.py",
      "services/api/app/data/endpoint_truth.json",
      "services/api/app/ci/check_cam_intent_schema_hash.py",
      "services/api/app/ci/endpoint_truth_gate.py",
      "services/api/requirements.txt",
      ".github/workflows/routing_truth.yml"
    ]
  },
  "inputs": {
    "truth_file": "services/api/app/data/endpoint_truth.json",
    "gate_script": "scripts/governance/check_routing_truth.py",
    "workflow": ".github/workflows/routing_truth.yml"
  },
  "diff_articulation": {
    "what_changed": [
      "Added scripts/governance/check_routing_truth.py - offline import routing truth gate",
      "Gate loads FastAPI app directly without server startup for faster CI",
      "Compares (METHOD, PATH) pairs from endpoint_truth.json vs app.router.routes",
      "Only enforces /api/* canonical paths by default (ROUTING_TRUTH_ENFORCE_API_ONLY)",
      "Handles deprecated routes with sunset date warnings",
      "LEGACY lane routes are warned but don't fail the gate",
      "Updated endpoint_truth.json to mark unimplemented endpoints as deprecated",
      "Fixed workflow ROUTING_TRUTH_TRUTH_FILE path (relative to working-directory)",
      "Added CI helper modules for CAM intent schema hash and endpoint truth gate",
      "Added requests dependency to requirements.txt"
    ],
    "why_not_redundant": "This provides a second validation layer (offline import) complementing the HTTP-based check_routing_truth.py in services/api/scripts/. The offline version is faster (no server boot), runs from repo root, and supports deprecated route handling with sunset dates. The HTTP version validates against the live server. Both are needed for complete coverage.",
    "behavior_preservation": {
      "invariants_kept": [
        "Existing HTTP-based routing truth check unchanged",
        "All documented routes still validated",
        "Non-API paths (/docs, /health) excluded from enforcement"
      ],
      "possible_regressions": [
        "Routes documented in truth file but not implemented will fail CI",
        "Undocumented routes generate warnings (not failures by default)"
      ]
    }
  },
  "verification": {
    "commands_run": [
      "python scripts/governance/check_routing_truth.py"
    ],
    "tests_added_or_updated": [],
    "evidence": [
      "Script imports app.main:app successfully",
      "Gate passes when truth file matches live routes",
      "Deprecated routes with LEGACY lane don't fail required check"
    ]
  },
  "review": {
    "reviewer_notes": "This gate runs in CI on any PR touching services/api/app/** or the truth file. It validates routing contract drift before merge.",
    "approvals_required": []
  }
}
