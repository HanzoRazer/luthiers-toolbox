# Session Bookmark: 2026-01-14

## Repository
https://github.com/HanzoRazer/luthiers-toolbox

## Summary
Locked the MVP DXF -> GRBL gcode golden path, added spindle commands to all post-processors, and fixed ezdxf parsing issues.

## Commits Made

```
cbe5d28 fix: add allow_missing_request_id marker to MVP golden test (03:46 AM)
534db34 feat(ai-context): Add AI Context Adapter v1 envelope (03:45 AM)
1562e2d ci: add MVP golden gate workflow and test README (03:38 AM)
ab84db6 test(cam): lock MVP DXF->GRBL gcode golden path (03:31 AM)
c945f0b fix(cam): fix ezdxf DXF parsing for plan_from_dxf endpoint (03:30 AM)
4f6f20c Merge pull request #5 from HanzoRazer/feat/design-first-workflow (03:16 AM)
a015150 Merge pull request #4 from HanzoRazer/feat/ai-context-adapter (03:15 AM)
75c56f9 chore: gitignore local test artifacts (03:13 AM)
4f5418a feat(art-studio): add Design-First Workflow (Bundle 32.7.0) (02:29 AM)
8073c8b feat(ai-context): add AI Context Adapter v1 (02:28 AM)
d718c2e docs: consolidate DXF workflow around plan_from_dxf golden path (02:20 AM)
580258d docs: fix DXF workflow doc to use plan_from_dxf golden path (02:06 AM)
a0736ae docs: fix curl examples for copy-paste correctness (02:01 AM)
bbe4c2e docs: fix Step 2 curl - use query params for to-adaptive (01:57 AM)
4704f6a docs: fix API response format in workflow examples (01:56 AM)
14ed2cf docs: update workflow with spindle command details (01:42 AM)
ae968d0 feat(cam): add spindle commands to all post-processors (01:38 AM)
37aebbb feat(cam): add spindle commands to GRBL post-processor (01:37 AM)
aea47e4 feat(cam): add spindle commands to Mach4 post-processor (01:26 AM)
6202e51 docs: update DXF workflow with correct post-processors (01:15 AM)
```

## Key Accomplishments

### 1. MVP Golden Path Test
The manufacturing spine of ToolBox is now locked:

```
DXF -> /api/cam/pocket/adaptive/plan_from_dxf -> GRBL G-code
```

Files created:
- `services/api/tests/testdata/mvp_rect_with_island.dxf` - Canonical fixture (100x50 rect + 20x10 island)
- `services/api/tests/golden/mvp_rect_with_island__grbl.nc` - Locked G-code snapshot (923 lines)
- `services/api/tests/test_mvp_dxf_to_gcode_grbl_golden.py` - Integration test
- `services/api/scripts/regenerate_mvp_golden_gcode.py` - Snapshot update script
- `services/api/tests/README.md` - Golden snapshot policy documentation

### 2. Spindle Commands for All Post-Processors
Added M3 S18000 (start), G4 P2 (dwell), and M5 (stop) to all 5 post-processors:
- GRBL
- Mach4
- LinuxCNC
- PathPilot
- MASSO

### 3. ezdxf DXF Parsing Fix
Fixed `plan_from_dxf` endpoint to use temp file + `readfile()` instead of StringIO (which fails for complex DXF files).

### 4. CI Workflow
Added `mvp_golden_gate.yml` workflow that triggers on changes to:
- Adaptive router code
- CAM logic
- Golden snapshot files

### 5. Design-First Workflow (Bundle 32.7.0)
Merged PR #5 with art studio design-first workflow feature.

### 6. AI Context Adapter v1
Merged PR #4 with AI context adapter envelope feature.

## Bugs Fixed

1. **ezdxf.read() fails with StringIO for complex DXF**
   - Switched to temp file + readfile() approach
   - Handle both dict and Pydantic model returns from plan()

2. **curl examples in docs had incorrect syntax**
   - Fixed query params for to-adaptive endpoint
   - Fixed API response format examples

## Golden Snapshot Policy

From `tests/README.md`:
- Golden files represent manufacturing intent
- Only regenerate when CAM logic intentionally changes
- All G-code differences must be reviewed as manufacturing behavior changes
- Use `python scripts/regenerate_mvp_golden_gcode.py` for intentional updates

## Test Parameters (MVP Golden Path)

```python
tool_d: 6.0 mm
stepover: 0.45 (45%)
stepdown: 1.5 mm
strategy: Spiral
feed_xy: 1200 mm/min
feed_z: 300 mm/min
rapid: 3000 mm/min
safe_z: 5.0 mm
z_rough: -3.0 mm
layer_name: GEOMETRY
climb: true
smoothing: 0.1
margin: 0.0
```

---

## RMOS Wrapping (Session Continued)

### New Endpoint

`POST /api/rmos/wrap/mvp/dxf-to-grbl`

Wraps the MVP golden path with RMOS governance:
- Creates run artifact with unique run_id
- Stores content-addressed attachments (DXF, plan, gcode, manifest)
- Records SHA256 hashes for audit
- Best-effort policy: returns G-code even if RMOS storage fails

### Files Created

- `services/api/app/rmos/mvp_wrapper.py` - RMOS wrapper endpoint
- `services/api/tests/test_rmos_mvp_wrapper.py` - 8 tests (all passing)

### Key Design Decisions

1. **Best-Effort RMOS** - G-code always returns, RMOS status reported in response
2. **Content-Addressed Attachments** - DXF, plan, gcode stored by SHA256
3. **Determinism Preserved** - Wrapper does not change CAM output
4. **Audit Trail** - Run artifacts created for every request

### Response Schema

```json
{
  "run_id": "run_<uuid>",
  "status": "GREEN|YELLOW|RED",
  "gcode_text": "...",
  "hashes": {
    "dxf": "<sha256>",
    "plan": "<sha256>",
    "gcode": "<sha256>",
    "manifest": "<sha256>"
  },
  "rmos_status": "ok|partial|failed",
  "warnings": []
}
```

### Test Results

8 tests passing:
- Unit tests: risk level computation, manifest schema
- Integration tests: wrapper returns gcode, creates RMOS artifact
- Determinism tests: wrapper produces same G-code moves as direct endpoint
- Best-effort tests: G-code returned even with RMOS issues

---

## Response Schema Update (Session Continued)

### Updated MVP Wrapper Response

Cleaned up response schema for clearer downstream integration:

```json
{
  "ok": true,
  "run_id": "run_<uuid>",
  "decision": {
    "risk_level": "GREEN|YELLOW|RED",
    "warnings": [],
    "block_reason": null
  },
  "hashes": {
    "feasibility_sha256": "<sha256>",
    "opplan_sha256": "<sha256>",
    "gcode_sha256": "<sha256>",
    "toolpaths_sha256": null
  },
  "attachments": [
    {
      "kind": "dxf_input|cam_plan|gcode_output|manifest",
      "sha256": "<sha256>",
      "filename": "...",
      "mime": "...",
      "size_bytes": 123,
      "created_at_utc": "..."
    }
  ],
  "gcode": {
    "inline": true,
    "text": "...",
    "path": null
  },
  "warnings": [],
  "rmos_persisted": true,
  "rmos_error": null
}
```

### Key Improvements

1. **Structured decision** - `decision.risk_level` instead of flat `status`
2. **Typed hashes** - `RMOSWrapHashes` with explicit fields instead of dict
3. **Explicit gcode delivery** - `gcode.inline` vs `gcode.path` for large files
4. **Attachment refs** - Full metadata for each content-addressed attachment
5. **Best-effort clarity** - `ok=true` even when `rmos_persisted=false`

### Files Modified

- `services/api/app/rmos/mvp_wrapper.py` - New response schemas
- `services/api/tests/test_rmos_mvp_wrapper.py` - Updated assertions
